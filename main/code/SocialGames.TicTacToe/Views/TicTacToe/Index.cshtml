@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script type="text/javascript" src="@Url.Content("~/Scripts/flXHR-1.0.6/flXHR.js")"></script>
<script type="text/javascript" src="@Url.Content("~/Scripts/flXHR-1.0.6/jquery.flXHRproxy.js")"></script>
<script src="@Url.Content("~/Scripts/game/ServerInterface.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/game/GameService.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/game/TicTacToeBoard.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/game/TicTacToeGame.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/game/TicTacToeViewModel.js")" type="text/javascript"></script>
<h2>
    Tic Tac Toe</h2>
<div data-bind="visible: (stage() == TicTacToeStage.Create)">
    <div>
    Welcome <b><span data-bind='text: playerName()'></span></b>
    </div>
    <div data-bind="visible: isOwner() && gameQueueId() != null">
        <span>Use this URL to invite other players: <span data-bind="text: inviteURL()" />
        </span>
        <br />
    </div>
    <div data-bind="visible: noPlayers() == 1">
        <span>Waiting for your opponent...</span>
    </div>
    <span>Current players:</span>
    <div data-bind='template: { name: "queueStatus", foreach: players()}' />
    <script id="queueStatus" type="text/html">
            <li><b>${$data.UserName}</b></li>
    </script>
</div>

<script type="text/javascript">
    var viewModel;
    var gameQueueId = getQueryVariable("id");

    sggamesqueuesCallback = function (gameQueueStatus) {
        viewModel.players(gameQueueStatus.Users);
    };

    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) {
                return pair[1];
            }
        }
    }

    $(function () {
        var apiURL = "http://127.0.0.1:81/";
        var blobURL = "http://127.0.0.1:10000/devstoreaccount1/";

        $.flXHRproxy.registerOptions(apiURL, { xmlResponseText: false, loadPolicyURL: apiURL + "crossdomain.xml" });

        var si = new ServerInterface();
        var gs = new GameService(apiURL, blobURL, si);

        viewModel = new TicTacToeViewModel();

        ko.applyBindings(viewModel);

        if (gameQueueId != null) {
            gs.joinGameQueue(gameQueueId, function (data) {
                gs.getGameQueueStatus(gameQueueId);
            });
        }
        else {
            gs.createGameQueue(function (data) {
                viewModel.isOwner(true);
                viewModel.gameQueueId(data);
                viewModel.inviteURL(document.location.href + "?id=" + data);

                gs.getGameQueueStatus(data);
            });
        }
    });
</script>
